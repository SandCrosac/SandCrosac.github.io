//<? //发布评论奖励
// 加载插件配置文件
$inc = get_plugin_inc('QS_website_plus');
$User = M("User");
$post_state = S('plugins_post');
$res = $post_state->find('*',['uid'=>NOW_UID]);
if($res){
    $jtime = A('Plugins');
    $atime = $jtime->timediff(NOW_TIME,$res['post_atime']);
    // 判断今日回帖奖励次数
    if($atime['day'] == 0 && $res['post_state']<$inc['post_cishu']){//如果是今天发帖奖励少于5次
        //增加金币
        $User->update_int(NOW_UID,'gold','+',$inc['post']);
        //增加积分
        $User->update_int(NOW_UID,'credits','+',$this->conf['credits_post']);
        $this->_user['posts']++;
        if($thread_data['uid'] != NOW_UID){
            M("Chat")->sys_send($thread_data['uid'],'<a href="'. HYBBS_URLA('my',NOW_USER).'" target="_blank">['.NOW_USER.']</a> 回复了你的主题 <a href="'. HYBBS_URLA('thread',$thread_data['tid']).'" target="_blank">['.$thread_data['title'].']</a>');
        }
        if($this->conf['gold_post'] != 0 || $this->conf['credits_post'] != 0){
            S("Log")->insert(array(
                'uid'=>NOW_UID,
                'gold'=>$inc['post'],
                'credits'=>$this->conf['credits_post'],
                'content'=>'发表评论 文章ID['.$thread_data['tid'].']',
                'atime'=>NOW_TIME
            ));
        }
        // 更新数据
        $post_state->update([
            "post_state[+]"=>1
        ],[
            'uid'=>NOW_UID
        ]);

    }else if($atime['day'] > 0){//如果是昨天
        //增加金币
        $User->update_int(NOW_UID,'gold','+',$inc['post']);
        //增加积分
        $User->update_int(NOW_UID,'credits','+',$this->conf['credits_post']);
        $this->_user['posts']++;
        if($thread_data['uid'] != NOW_UID){
            M("Chat")->sys_send($thread_data['uid'],'<a href="'. HYBBS_URLA('my',NOW_USER).'" target="_blank">['.NOW_USER.']</a> 回复了你的主题 <a href="'. HYBBS_URLA('thread',$thread_data['tid']).'" target="_blank">['.$thread_data['title'].']</a>');
        }
        if($this->conf['gold_post'] != 0 || $this->conf['credits_post'] != 0){
            S("Log")->insert(array(
                'uid'=>NOW_UID,
                'gold'=>$inc['post'],
                'credits'=>$this->conf['credits_post'],
                'content'=>'发表评论 文章ID['.$thread_data['tid'].']',
                'atime'=>NOW_TIME
            ));
        }
        $post_state->update([
            'post_state'  => 1,
            'post_atime'  => mktime(0,0,0,date("m"),date("d"),date("Y"))
        ],['uid'=>NOW_UID]);
    }
}else{//记录第一次奖励
    //增加金币
    $User->update_int(NOW_UID,'gold','+',$inc['post']);
    //增加积分
    $User->update_int(NOW_UID,'credits','+',$this->conf['credits_post']);
    $this->_user['posts']++;
    if($thread_data['uid'] != NOW_UID){
        M("Chat")->sys_send($thread_data['uid'],'<a href="'. HYBBS_URLA('my',NOW_USER).'" target="_blank">['.NOW_USER.']</a> 回复了你的主题 <a href="'. HYBBS_URLA('thread',$thread_data['tid']).'" target="_blank">['.$thread_data['title'].']</a>');
    }
    if($this->conf['gold_post'] != 0 || $this->conf['credits_post'] != 0){
        S("Log")->insert(array(
            'uid'=>NOW_UID,
            'gold'=>$inc['post'],
            'credits'=>$this->conf['credits_post'],
            'content'=>'发表评论 文章ID['.$thread_data['tid'].']',
            'atime'=>NOW_TIME
        ));
    }
    $post_state->insert([
        'uid'           => NOW_UID,
        'post_state'  => 1,
        'post_atime'  => mktime(0,0,0,date("m"),date("d"),date("Y"))
    ]);
}

//{hook a_post_post_9}

if($thread_data['top'] == 2)
    $this->CacheObj->rm("top_data_2");
elseif($thread_data['top'] == 1)
    $this->CacheObj->rm("forum_top_id_".$thread_data['fid']);

$this->CacheObj->rm("index_index_Btime_1");
$this->CacheObj->rm("index_index_{$thread_data['fid']}_1_Btime");
$this->CacheObj->rm('thread_data_'.$tid);

$count = intval(($thread_data['posts'] /  $this->conf['postlist']) + 1)+1;
for ($i=0; $i < $count; $i++) {
    $this->CacheObj->rm("post_list_{$tid}_DESC_{$i}");
    $this->CacheObj->rm("post_list_{$tid}_ASC_{$i}");
}


//用户组升级检测
M('Usergroup')->check_up(NOW_UID);


//{hook a_post_post_v}
return $this->json(array('error'=>true,'info'=>'发表成功'));exit;